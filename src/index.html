<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
        <meta name="theme-color" content="#0f172a" />
        <title>Tracking GPS - Dashboard</title>
        <link rel="stylesheet" href="./styles.css" />
    </head>
    <body class="dashboard-app">
        <!-- Header -->
        <header class="dash-header">
            <div class="dash-header__brand">
                <svg class="dash-header__icon" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="10" r="3"/>
                    <path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 10-16 0c0 3 2.7 7 8 11.7z"/>
                </svg>
                <h1 class="dash-header__title">Tracking GPS</h1>
            </div>
        </header>

        <!-- Main Content -->
        <main class="dash-main">
            <!-- Stats Summary -->
            <section class="dash-stats">
                <div class="dash-stat">
                    <span class="dash-stat__value" id="total-routes">0</span>
                    <span class="dash-stat__label">Recorridos</span>
                </div>
                <div class="dash-stat">
                    <span class="dash-stat__value" id="total-distance">0</span>
                    <span class="dash-stat__label">km totales</span>
                </div>
                <div class="dash-stat">
                    <span class="dash-stat__value" id="total-points">0</span>
                    <span class="dash-stat__label">Puntos GPS</span>
                </div>
            </section>

            <!-- Pending Route Banner -->
            <section class="pending-route" id="pending-route" style="display: none;">
                <div class="pending-route__icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                </div>
                <div class="pending-route__info">
                    <h3 class="pending-route__title">Recorrido en progreso</h3>
                    <p class="pending-route__desc">
                        <strong id="pending-route-name">--</strong> · 
                        <span id="pending-route-points">0</span> puntos
                    </p>
                </div>
                <div class="pending-route__actions">
                    <button type="button" id="btn-pending-continue" class="pending-route__btn pending-route__btn--primary">
                        Continuar
                    </button>
                    <button type="button" id="btn-pending-discard" class="pending-route__btn pending-route__btn--danger">
                        Descartar
                    </button>
                </div>
            </section>

            <!-- Routes Section -->
            <section class="dash-section">
                <div class="dash-section__header">
                    <h2 class="dash-section__title">Mis Recorridos</h2>
                    <label class="dash-import-btn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                            <polyline points="7,10 12,15 17,10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        <span>Importar</span>
                        <input type="file" id="file-input" accept=".json" hidden />
                    </label>
                </div>
                
                <div id="routes-list" class="routes-grid">
                    <!-- Routes loaded dynamically -->
                </div>
            </section>
        </main>

        <!-- FAB: New Route -->
        <a href="./track.html" class="dash-fab" aria-label="Nuevo Recorrido">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
        </a>

        <script type="module">
            import { StorageService } from './core/StorageService.js';
            import { Route } from './models/Route.js';
            import { Notifications } from './ui/Notifications.js';
            import { EventBus } from './core/EventBus.js';

            const storage = new StorageService('tracking_routes');

            /**
             * Actualiza las estadísticas del dashboard
             */
            function updateStats(routes) {
                const totalRoutes = routes.length;
                const totalDistance = routes.reduce((sum, r) => sum + (r.distance || 0), 0);
                const totalPoints = routes.reduce((sum, r) => sum + (r.points?.length || 0), 0);

                document.getElementById('total-routes').textContent = totalRoutes;
                document.getElementById('total-distance').textContent = totalDistance.toFixed(1);
                document.getElementById('total-points').textContent = totalPoints;
            }

            /**
             * Renderiza la lista de recorridos
             */
            function renderRoutes() {
                const routes = storage.getAll();
                const container = document.getElementById('routes-list');

                updateStats(routes);

                if (routes.length === 0) {
                    container.innerHTML = `
                        <div class="routes-empty">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.5">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
                                <circle cx="12" cy="10" r="3"/>
                            </svg>
                            <p class="routes-empty__title">No hay recorridos</p>
                            <p class="routes-empty__hint">Toca + para crear uno nuevo</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = routes.map((route, index) => `
                    <article class="route-item" data-id="${route.id}">
                        <a href="./route-detail.html?id=${route.id}" class="route-item__link">
                            <div class="route-item__header">
                                <h3 class="route-item__name">${route.name || `Recorrido ${index + 1}`}</h3>
                                <span class="route-item__date">${formatDate(route.createdAt)}</span>
                            </div>
                            <div class="route-item__stats">
                                <div class="route-item__stat">
                                    <span class="route-item__stat-value">${(route.distance || 0).toFixed(2)}</span>
                                    <span class="route-item__stat-unit">km</span>
                                </div>
                                <div class="route-item__stat">
                                    <span class="route-item__stat-value">${route.points?.length || 0}</span>
                                    <span class="route-item__stat-unit">pts</span>
                                </div>
                            </div>
                        </a>
                        <div class="route-item__actions">
                            <button class="route-item__btn" onclick="exportRoute('${route.id}')" title="Exportar">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                                    <polyline points="17,8 12,3 7,8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                            </button>
                            <button class="route-item__btn route-item__btn--danger" onclick="deleteRoute('${route.id}')" title="Eliminar">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3,6 5,6 21,6"/>
                                    <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                </svg>
                            </button>
                        </div>
                    </article>
                `).join('');
            }

            /**
             * Formatea una fecha ISO a formato legible
             * @param {string} isoDate 
             * @returns {string}
             */
            function formatDate(isoDate) {
                if (!isoDate) return 'Sin fecha';
                const date = new Date(isoDate);
                return date.toLocaleDateString('es-PE', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
            }

            /**
             * Exporta un recorrido a JSON
             * @param {string} id 
             */
            window.exportRoute = function(id) {
                const route = storage.getById(id);
                if (route) {
                    storage.exportToJson(route);
                    Notifications.success('Recorrido exportado');
                }
            };

            /**
             * Elimina un recorrido
             * @param {string} id 
             */
            window.deleteRoute = function(id) {
                if (confirm('¿Eliminar este recorrido?')) {
                    storage.delete(id);
                    renderRoutes();
                    Notifications.info('Recorrido eliminado');
                }
            };

            /**
             * Maneja importación de archivo JSON
             * @param {Event} event 
             */
            async function handleImport(event) {
                const file = event.target.files[0];
                if (!file) return;

                try {
                    const points = await storage.importFromJson(file);
                    
                    const route = new Route(`Importado - ${file.name.replace('.json', '')}`);
                    points.forEach(p => route.addPoint(p.lat, p.lng));
                    
                    storage.save(route.toJSON());
                    renderRoutes();
                    Notifications.success(`Importado: ${points.length} puntos`);
                } catch (error) {
                    Notifications.error(error.message);
                }
                
                // Reset input
                event.target.value = '';
            }

            // Event listeners
            document.getElementById('file-input').addEventListener('change', handleImport);

            // Subscribe to storage events
            EventBus.on('route:saved', renderRoutes);
            EventBus.on('route:deleted', renderRoutes);

            /**
             * Verifica si hay un recorrido pendiente
             */
            function checkPendingRoute() {
                try {
                    const data = localStorage.getItem('tracking_pending_route');
                    if (!data) return;

                    const pendingData = JSON.parse(data);
                    if (!pendingData?.points?.length) return;

                    // Check if not too old (24 hours)
                    const maxAge = 24 * 60 * 60 * 1000;
                    const age = Date.now() - pendingData.savedAt;
                    if (age >= maxAge) {
                        localStorage.removeItem('tracking_pending_route');
                        return;
                    }

                    // Show pending route banner
                    const banner = document.getElementById('pending-route');
                    document.getElementById('pending-route-name').textContent = pendingData.name || 'Sin nombre';
                    document.getElementById('pending-route-points').textContent = pendingData.points.length;
                    banner.style.display = 'flex';
                } catch (err) {
                    console.error('Error checking pending route:', err);
                }
            }

            /**
             * Continuar recorrido pendiente
             */
            function continuePendingRoute() {
                window.location.href = './track.html?resume=true';
            }

            /**
             * Descartar recorrido pendiente
             */
            function discardPendingRoute() {
                localStorage.removeItem('tracking_pending_route');
                document.getElementById('pending-route').style.display = 'none';
                Notifications.info('Recorrido descartado');
            }

            // Pending route event listeners
            document.getElementById('btn-pending-continue')?.addEventListener('click', continuePendingRoute);
            document.getElementById('btn-pending-discard')?.addEventListener('click', discardPendingRoute);

            // Initial render
            renderRoutes();
            checkPendingRoute();
        </script>
    </body>
</html>
