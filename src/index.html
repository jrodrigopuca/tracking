<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Tracking GPS - Dashboard</title>
        <link rel="stylesheet" href="./styles.css" />
    </head>
    <body>
        <header class="header">
            <h1 class="header__title">üó∫Ô∏è Tracking GPS</h1>
        </header>

        <main class="main main--dashboard">
            <section class="dashboard">
                <div class="dashboard__actions">
                    <a href="./track.html" class="btn btn--primary btn--large">
                        <span class="btn__icon">‚ûï</span>
                        Nuevo Recorrido
                    </a>
                    
                    <label class="btn btn--secondary btn--large">
                        <span class="btn__icon">üì•</span>
                        Importar JSON
                        <input type="file" id="file-input" accept=".json" hidden />
                    </label>
                </div>

                <h2 class="dashboard__subtitle">Mis Recorridos</h2>
                
                <div id="routes-list" class="routes-list">
                    <!-- Routes loaded dynamically -->
                </div>
            </section>
        </main>

        <script type="module">
            import { StorageService } from './core/StorageService.js';
            import { Route } from './models/Route.js';
            import { Notifications } from './ui/Notifications.js';
            import { EventBus } from './core/EventBus.js';

            const storage = new StorageService('tracking_routes');

            /**
             * Renderiza la lista de recorridos
             */
            function renderRoutes() {
                const routes = storage.getAll();
                const container = document.getElementById('routes-list');

                if (routes.length === 0) {
                    container.innerHTML = `
                        <div class="routes-list__empty">
                            <p>No hay recorridos guardados</p>
                            <p class="routes-list__hint">Crea uno nuevo o importa un archivo JSON</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = routes.map((route, index) => `
                    <article class="route-card" data-id="${route.id}">
                        <div class="route-card__info">
                            <h3 class="route-card__name">${route.name || `Recorrido ${index + 1}`}</h3>
                            <div class="route-card__meta">
                                <span class="route-card__distance">üìè ${(route.distance || 0).toFixed(2)} km</span>
                                <span class="route-card__points">üìç ${route.points?.length || 0} puntos</span>
                                <span class="route-card__date">üìÖ ${formatDate(route.createdAt)}</span>
                            </div>
                        </div>
                        <div class="route-card__actions">
                            <a href="./track.html?id=${route.id}" class="btn btn--small btn--primary">Ver</a>
                            <button class="btn btn--small btn--secondary" onclick="exportRoute('${route.id}')">Exportar</button>
                            <button class="btn btn--small btn--danger" onclick="deleteRoute('${route.id}')">Eliminar</button>
                        </div>
                    </article>
                `).join('');
            }

            /**
             * Formatea una fecha ISO a formato legible
             * @param {string} isoDate 
             * @returns {string}
             */
            function formatDate(isoDate) {
                if (!isoDate) return 'Sin fecha';
                const date = new Date(isoDate);
                return date.toLocaleDateString('es-PE', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
            }

            /**
             * Exporta un recorrido a JSON
             * @param {string} id 
             */
            window.exportRoute = function(id) {
                const route = storage.getById(id);
                if (route) {
                    storage.exportToJson(route);
                    Notifications.success('Recorrido exportado');
                }
            };

            /**
             * Elimina un recorrido
             * @param {string} id 
             */
            window.deleteRoute = function(id) {
                if (confirm('¬øEliminar este recorrido?')) {
                    storage.delete(id);
                    renderRoutes();
                    Notifications.info('Recorrido eliminado');
                }
            };

            /**
             * Maneja importaci√≥n de archivo JSON
             * @param {Event} event 
             */
            async function handleImport(event) {
                const file = event.target.files[0];
                if (!file) return;

                try {
                    const points = await storage.importFromJson(file);
                    
                    const route = new Route(`Importado - ${file.name.replace('.json', '')}`);
                    points.forEach(p => route.addPoint(p.lat, p.lng));
                    
                    storage.save(route.toJSON());
                    renderRoutes();
                    Notifications.success(`Importado: ${points.length} puntos`);
                } catch (error) {
                    Notifications.error(error.message);
                }
                
                // Reset input
                event.target.value = '';
            }

            // Event listeners
            document.getElementById('file-input').addEventListener('change', handleImport);

            // Subscribe to storage events
            EventBus.on('route:saved', renderRoutes);
            EventBus.on('route:deleted', renderRoutes);

            // Initial render
            renderRoutes();
        </script>
    </body>
</html>
