<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="initial-scale=1.0, width=device-width" />
		<title>Seguimiento de Recorrido con HERE Maps</title>
		<script
			src="https://js.api.here.com/v3/3.1/mapsjs-core.js"
			type="text/javascript"
			charset="utf-8"
		></script>
		<script
			src="https://js.api.here.com/v3/3.1/mapsjs-service.js"
			type="text/javascript"
			charset="utf-8"
		></script>
		<script
			src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"
			type="text/javascript"
			charset="utf-8"
		></script>
		<script
			src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"
			type="text/javascript"
			charset="utf-8"
		></script>
	</head>
	<style>
		#map-container {
			height: calc(100vh - 64px);
			width: 100%;
		}
	</style>
	<body>
		<div id="map-container"></div>
		<button id="start-button">Iniciar</button>
		<button id="stop-button">Terminar</button>
    <button id="export-button">Export</button>
		<div id="info"></div>
    <ul id="list"></ul>

		<script>
			let watchLocation = null;
			let map;
			let platform;
			let path = [];
			let distance = 0;
			let polyline;

			const calculateDistance = (lat1, lon1, lat2, lon2) => {
				const radlat1 = (Math.PI * lat1) / 180;
				const radlat2 = (Math.PI * lat2) / 180;
				const radlon1 = (Math.PI * lon1) / 180;
				const radlon2 = (Math.PI * lon2) / 180;
				const theta = lon1 - lon2;
				const radtheta = (Math.PI * theta) / 180;
				let dist =
					Math.sin(radlat1) * Math.sin(radlat2) +
					Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
				dist = Math.acos(dist);
				dist = (dist * 180) / Math.PI;
				dist = dist * 60 * 1.1515;
				dist = dist * 1.609344 * 1000; // Convert to meters
				return dist;
			};

			const updateDistance = (pos) => {
				if (path.length > 1) {
					distance += calculateDistance(
						path[path.length - 2].lat,
						path[path.length - 2].lng,
						pos.lat,
						pos.lng
					);

					if (polyline) {
						map.removeObject(polyline);
					}
					/*polyline = new H.map.Polyline(path, {
						style: { strokeColor: "blue", lineWidth: 3 },
					});*/
					const lineString = new H.geo.LineString();
					path.forEach((pos) => {
						lineString.pushPoint(new H.geo.Point(pos.lat, pos.lng));
					});
					polyline = new H.map.Polyline(lineString, {
						style: { strokeColor: "blue", lineWidth: 3 },
					});
					map.addObject(polyline);
				}
				document.getElementById("info").innerHTML = `
          <p>Distancia recorrida: ${distance.toFixed(2)} metros</p>
          <p>Puntos recorridos: ${path.length}</p>
        `;
			};

      const updateList = (pos) => {
        const ul = document.getElementById("list");
        ul.innerHTML+=`<li>Lat:${pos.lat}  Lng:${pos.lng}</li>`
      }

			const initConditions = () => {
				// Cargar la API de Here Maps
				platform = new H.service.Platform({
					apikey: "",
				});
				// Crear una instancia del mapa
				const defaultLayers = platform.createDefaultLayers();

				map = new H.Map(
					document.getElementById("map-container"),
					defaultLayers.vector.normal.map,
					{
						zoom: 18,
						center: { lat: 37.386052, lng: -122.083851 },
						pixelRatio: window.devicePixelRatio || 1,
						canvas: document.createElement("canvas", {
							willReadFrequently: true,
						}),
					}
				);

				const behavior = new H.mapevents.Behavior(
					new H.mapevents.MapEvents(map)
				);
			};

			if (navigator.geolocation) {
				initConditions();
				window.addEventListener("resize", () => map.getViewPort().resize());
			} else {
				document.getElementById(
					"info"
				).innerHTML = `GeolocalizaciÃ³n no soportada`;
			}

			const stopTracking = () => {
				if (watchLocation) {
					navigator.geolocation.clearWatch(watchLocation);
				}
				document.getElementById("start-button").style.display = "block";
				document.getElementById("stop-button").style.display = "none";
			};

			const startTracking = () => {
				if (navigator.geolocation) {
					watchLocation = navigator.geolocation.watchPosition((position) => {
						const actualPosition = {
							lat: position.coords.latitude,
							lng: position.coords.longitude,
						};

						console.log("cambio", actualPosition);
						path.push(actualPosition);
						map.addObject(new H.map.Marker(actualPosition));
						map.setCenter(actualPosition);
            updateList(actualPosition);
						updateDistance(actualPosition);
						document.getElementById("start-button").style.display = "none";
						document.getElementById("stop-button").style.display = "block";
					});
				}
			};

			const exportPath = () => {
				const jsonData = JSON.stringify(path);
				const blob = new Blob([jsonData], { type: "application/json" });
				const url = URL.createObjectURL(blob);
				const a = document.createElement("a");
				a.href = url;
				a.download = "recorrido.json";
				document.body.appendChild(a);
				a.click();
				document.body.removeChild(a);
				URL.revokeObjectURL(url);
			};

			document
				.getElementById("start-button")
				.addEventListener("click", startTracking);
			document
				.getElementById("stop-button")
				.addEventListener("click", stopTracking);
      document
				.getElementById("export-button")
				.addEventListener("click", exportPath);
		</script>
	</body>
</html>
